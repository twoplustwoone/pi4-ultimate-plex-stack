x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  plex:
    image: ${PLEX_IMAGE:-lscr.io/linuxserver/plex:latest}
    container_name: plex
    network_mode: host
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - ${BASE_PATH}/plex/config:/config
      - ${MEDIA_SHARE}:/share
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://127.0.0.1:32400/identity > /dev/null || wget -q -O- http://127.0.0.1:32400/identity > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  radarr:
    image: ${RADARR_IMAGE:-lscr.io/linuxserver/radarr:latest}
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/radarr/config:/config
      - ${MEDIA_SHARE}:/share
    ports:
      - 7878:7878
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:7878/ > /dev/null || wget -q -O- http://localhost:7878/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  sonarr:
    image: ${SONARR_IMAGE:-lscr.io/linuxserver/sonarr:latest}
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/sonarr/config:/config
      - ${MEDIA_SHARE}:/share
    ports:
      - 8989:8989
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:8989/ > /dev/null || wget -q -O- http://localhost:8989/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  overseerr:
    image: ${OVERSEERR_IMAGE:-ghcr.io/sct/overseerr:latest}
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/overseerr/config:/app/config
      - ${MEDIA_SHARE}:/share
    ports:
      - 5055:5055
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:5055/ > /dev/null || wget -q -O- http://localhost:5055/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  qbittorrent:
    image: ${QBITTORRENT_IMAGE:-lscr.io/linuxserver/qbittorrent:latest}
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - ${BASE_PATH}/qbittorrent/config:/config
      - ${MEDIA_SHARE}:/share
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    depends_on:
      gluetun:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:8080/ > /dev/null || wget -q -O- http://localhost:8080/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  gluetun:
    image: ${GLUETUN_IMAGE:-qmcgaw/gluetun:latest}
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    ports:
      - 8080:8080 # qBittorrent WebUI
    volumes:
      - ${BASE_PATH}/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=private internet access
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${OPENVPN_USER}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}
      - TZ=${TZ}
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "ip link show up | grep -Eq 'tun[0-9]+|wg[0-9]+'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 2m

  unpackerr:
    image: ${UNPACKERR_IMAGE:-golift/unpackerr:latest}
    container_name: unpackerr
    profiles: ["advanced"]
    user: "${PUID}:${PGID}"
    environment:
      - TZ=${TZ}
      - UN_START_DELAY=1m
      - UN_SONARR_0_URL=http://sonarr:8989
      - UN_SONARR_0_API_KEY=${SONARR_KEY}
      - UN_SONARR_0_TIMEOUT=10s
      - UN_RADARR_0_URL=http://radarr:7878
      - UN_RADARR_0_API_KEY=${RADARR_KEY}
      - UN_RADARR_0_TIMEOUT=10s
    volumes:
      - ${MEDIA_SHARE}:/share
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    depends_on:
      sonarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/unpackerr", "--version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  prowlarr:
    image: ${PROWLARR_IMAGE:-lscr.io/linuxserver/prowlarr:latest}
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/prowlarr/config:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:9696/ > /dev/null || wget -q -O- http://localhost:9696/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  tautulli:
    image: ${TAUTULLI_IMAGE:-lscr.io/linuxserver/tautulli:latest}
    container_name: tautulli
    profiles: ["advanced"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/tautulli/config:/config
    ports:
      - 8181:8181
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:8181/ > /dev/null || wget -q -O- http://localhost:8181/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  bazarr:
    image: ${BAZARR_IMAGE:-lscr.io/linuxserver/bazarr:latest}
    container_name: bazarr
    profiles: ["advanced"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${BASE_PATH}/bazarr/config:/config
      - ${MEDIA_SHARE}:/share
    ports:
      - 6767:6767
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:6767/ > /dev/null || wget -q -O- http://localhost:6767/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  cross-seed:
    image: ${CROSS_SEED_IMAGE:-ghcr.io/cross-seed/cross-seed:latest}
    container_name: cross-seed
    profiles: ["advanced"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - CONFIG_DIR=/config
      - DOCKER_ENV=true
      - QBITTORRENT_HOST=${QBITTORRENT_HOST:-gluetun}
      - QBITTORRENT_PORT=${QBITTORRENT_PORT:-8080}
      - QBITTORRENT_USER=${QBITTORRENT_USER}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS}
      - PROWLARR_URL=${PROWLARR_URL:-http://prowlarr:9696}
      - PROWLARR_API_KEY=${PROWLARR_API_KEY}
    volumes:
      - ./cross-seed/config:/config
      - ${MEDIA_SHARE}:/share
      - ${BASE_PATH}/qbittorrent/config/qBittorrent/BT_backup:/torrents:ro
      - ${MEDIA_SHARE}/cross-seed/current-cross-seeds:/cross-seeds
    ports:
      - "2468:2468"
    command: ["daemon"]
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    depends_on:
      qbittorrent:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:2468/api/ping > /dev/null || wget -q -O- http://localhost:2468/api/ping > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  autobrr:
    container_name: autobrr
    image: ${AUTOBRR_IMAGE:-ghcr.io/autobrr/autobrr:latest}
    profiles: ["advanced"]
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - ${BASE_PATH}/autobrr/config:/config
    ports:
      - 7474:7474
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:7474/ > /dev/null || wget -q -O- http://localhost:7474/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  dozzle:
    image: ${DOZZLE_IMAGE:-amir20/dozzle:latest}
    container_name: dozzle
    profiles: ["advanced"]
    ports:
      - 9999:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      # Dozzle image is distroless on some tags (no /bin/sh, curl, or wget).
      test: ["CMD", "/dozzle", "--version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  flaresolverr:
    image: ${FLARESOLVERR_IMAGE:-ghcr.io/flaresolverr/flaresolverr:latest}
    container_name: flaresolverr
    profiles: ["advanced"]
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=${TZ}
    ports:
      - 8191:8191
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:8191/ > /dev/null || wget -q -O- http://localhost:8191/ > /dev/null",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  watchtower:
    image: ${WATCHTOWER_IMAGE:-containrrr/watchtower:latest}
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ}
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - WATCHTOWER_LIFE_CYCLE_HOOKS=false
      - WATCHTOWER_ROLLING_RESTART=false
      - WATCHTOWER_INTERVAL=86400
      - WATCHTOWER_SCHEDULE=
      - WATCHTOWER_LOG_LEVEL=info
      - WATCHTOWER_NOTIFICATION_REPORT=true
      - WATCHTOWER_NOTIFICATION_REPORT_ONLY=true
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging

  uptime-kuma:
    image: ${UPTIME_KUMA_IMAGE:-louislam/uptime-kuma:1}
    container_name: uptime-kuma
    profiles: ["advanced"]
    ports:
      - 3001:3001
    volumes:
      - ${BASE_PATH}/uptime-kuma:/app/data
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sS http://localhost:3001/ > /dev/null || wget -q -O- http://localhost:3001/ > /dev/null",
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

  cloudflared:
    image: ${CLOUDFLARE_IMAGE:-cloudflare/cloudflared:latest}
    container_name: cloudflared
    command: tunnel --protocol http2 run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    dns:
      - 1.1.1.1
      - 1.0.0.1
    volumes:
      - ${BASE_PATH}/cloudflared:/etc/cloudflared
    restart: unless-stopped
    pull_policy: if_not_present
    logging: *default-logging
    healthcheck:
      # Cloudflared image may not include /bin/sh; avoid CMD-SHELL checks.
      test: ["CMD", "cloudflared", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
